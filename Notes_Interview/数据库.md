# 数据库

## # 数据库事务

> [事务](http://www.cnblogs.com/xdp-gacl/p/3984001.html)
>
> [事务并发的可能问题与其解决方案](https://www.jianshu.com/p/71a79d838443)

### 四大特性（ACID）

+ 原子性（Atomicity）：事务所包含的所有操作要么全部成功，要么全部失败回滚。
+ 一致性（Consistency）：事务必须使数据库从一个一致性状态转换到另一个一致性状态。（事务对系统的修改是量子化的，不是线性的）
+ 隔离性（Isolation）：事务不能被其他事务的操作所干扰，多个事务之间要相互隔离。
+ 持久性（Durability）：事务一旦提交，对数据库中的数据的改变就是永久性的。

### 事务并发引起的问题

+ 脏读（Dirty Read）：一个事务读取到了另一个未提交事务写的数据。
+ 不可重复读（Non-Repeatable Read）：在一个事务内读取表中的同一行数据，多次读取结果不同。
+ 虚读、幻读（Phantom Read）：一个事务中两次查询，但第二次查询比第一次查询多了或少了几行或几列数据。
+ 丢失更改（Lost Update）：
  + 第一类丢失更改，回滚覆盖：撤销一个事务时，回滚该事务的写操作，把其他已提交的事务写入的数据覆盖了。
  + 第二类丢失更改，提交覆盖：提交一个事务时，写操作依赖事务内读取到的数据，读发生在其他事务提交前，写发生在其他事务提交后，把其他已提交的事务写入的数据覆盖了。这是不可重复读的特例。

小结：脏读读到的是**未提交**数据，不可重复读读到的**可以是已提交**的数据；不可重复读侧重于**修改**，幻读侧重于**新增或删除**。解决不可重复读的问题只需锁住满足条件的行，解决幻读需要锁表。

### 事务隔离级别

+ 读未提交（Read Uncommitted）：事务读不阻塞其他事务读和写，事务写阻塞其他事务写但不阻塞读。
+ 读已提交（Read Committed）：事务读不会阻塞其他事务读和写，事务写会阻塞其他事务读和写。
+ 可重复读（Repeatable Rea）：事务读会阻塞其他事务写但不阻塞读，事务写会阻塞其他事务读和写。
+ 串行化（Serializable ）：所有的增删改查串行执行。“行级锁”做不到，需使用“表级锁”。

### 三级加锁协议及两段锁协议

+ 一级加锁协议：事务在修改数据前必须加X锁（Exclusive locks, X-locks 排它锁），直到事务结束（提交或终止）才可释放；如果仅仅是读数据，不需要加锁。
+ 二级加锁协议：满足一级加锁协议，且事务读取数据之前必须先加S锁（Shared locks, S-locks 共享锁），读完后即可释放S锁。
+ 三级加锁协议：满足以及加锁协议，且事务在读取事务之前必须先加S锁，知道事务结束才释放。
+ 两段锁协议：
  + 加锁阶段：事务在读数据前加S锁，写数据前加X锁，加锁不成功则等待。
  + 解锁阶段：一旦开始释放锁，就不允许再加锁。
  + 若并发执行的所有事务均遵守两段锁协议，则对这些事务的任何并发调度策略都是可串行化的。
  + 遵循两段锁协议的事务调度处理的结果是可串行化的充分条件，但是可串行化并不一定遵循两段锁协议。

| 事务隔离级别 | 回滚覆盖 | 脏读     | 不可重复读 | 提交覆盖 | 幻读     | 加锁协议     |
| ------------ | -------- | -------- | ---------- | -------- | -------- | ------------ |
| 读未提交     | x        | 可能发生 | 可能发生   | 可能发生 | 可能发生 | 一级加锁协议 |
| 读已提交     | x        | x        | 可能发生   | 可能发生 | 可能发生 | 二级加锁协议 |
| 可重复读     | x        | x        | x          | x        | 可能发生 | 三级加锁协议 |
| 串行化       | x        | x        | x          | x        | x        | 两段锁协议   |

## # 分库分表

> [数据库分库分表策略的具体实现方案](https://blog.csdn.net/xlgen157387/article/details/53976153)
>
> [大众点评订单系统分库分表实践](https://tech.meituan.com/dianping_order_db_sharding.html)
>
> [分库分表需要考虑的问题及方案](https://www.jianshu.com/p/32b3e91aa22c)

