# 重构剑法之山重水复疑无路

## 楔子

是夜，一轮明月挂在树梢，微风轻拂，掀起淡淡花香。

江边有一艘小船靠岸停下，烛光悠悠。之前吹笛的白衣少年，此刻已起了倦意，合上了眼眸。然而夜晚并不似表面这般平静，一股杀机已从江边小树林中悄悄蔓延出来。定睛一看，一名黑衣男子正朝着少年的方向潜行过来，妄图趁白衣少年不备，就要使出一招吸星大法。

眼见那男子快要得逞，殊不知白衣少年早已用“委托”和“代理”心法，将自己七魄中的二魄灵慧移到了鞘中利剑。还未等男子靠近半分，“咻”的一声，宝剑自行飞出，带着凌冽的剑气直指黑衣男子而去。心中暗道“不好”，黑衣男子旋即放弃进攻，抽身后退。“你在等我？”，男子的语气中夹带了些许诧异，显然没料到这是少年故意布下的局，局中先前隐匿的白棋一一浮现，杀气四漏。

“不，是在等一个将死之人”，少年睁开了眼睛，收回宝剑。男子闷哼一声，随即不知用了什么奇门遁甲之术，将自己的身形隐去，百般招式接连不断向少年扔来。少年微微皱眉，未见犹豫，便将自身内力放了出来，一道“卫语句”屏障浮现在身体周围，使得黑衣男子一时间无法靠近半丈。未等男子发动下一轮攻击，少年一记“断言”剑法朝前方劈出。男子再无所遁形，身法中的破绽也一一展现，每一击都被少年轻松接下。但看那少年，依旧如先前一般，左手握着一支竹笛背在身后，只用了单单右手应对，下盘纹丝未动，好生潇洒随意。

男子面露难色，知道自己凶多吉少，便横下心以燃烧生命为代价，使出那“杀敌一千自损八百”的秘技，硬生生将自己的内力提高了好几个层次。手中的动作也变得迅猛狠辣起来，上中下三路齐出，妄图打他个措手不及。但看那白衣少年神色坦然并不慌忙，左手“函数式编程”，右手“策略模式”将男子各路套数纷纷化解。末了，少年还不忘喂给男子一剑。这看似简单的一剑，却蕴藏了无穷的内劲，缘是那少年使用“继承”和“封装”，借助“模板方法”将万般武学精华融进了这一招式中。这一剑直中要害，打的男子元神俱灭，卧地不起。

事罢，白衣少年重新点燃了刚才打斗中熄灭的烛火，拂衣而去，留下已无还手能力的男子任他自生自灭。“这，是什么剑法？”，躺在地上的男子呼吸渐失，问了自己在这世上的最后一个问题。“重构”，一声回复从远处悠悠传来，碧波荡漾，岸边已不见之前停靠的小船。

此刻，一轮红日缓缓升起，照的江面熠熠生辉。

## 序章

随着对团队项目的理解不断加深，编码也愈发熟练，因而开发之余会有一些时间去思考项目代码的优化，并把自己的一些思考付诸实践。本系列文章便是记录自己从《重构（Refactoring）》一书中所学各项技巧在真实项目（以 Kotlin 为编程语言的 Web 后台项目）中的思考和运用。如果其中有一条能给你带来启发，运用在后续的代码编写中，对我来说就是莫大的鼓舞。我非常推荐你阅读《重构》这本书，事不宜迟，赶快上车。（在此感谢送给我这本电子书的引路人 —— 张师傅）

### 重构三问

我们每天所写的代码直接面向的用户主要有三个：当下的自己、计算机和未来的开发者，其中未来的开发者可能仍旧是我们自己，也或许是接手代码的人，多数情况下则是代码调用方。对我们自己而言，短时间内为了效率，并不要求代码的简洁和扩展性。对电脑我们只需要准确描述自己的意图即可。当然，有时候我们会表述不清，导致计算机的理解出现问题。

这一篇文章让我们放松心情，先从概念出发，讲讲重构的定义、目的和时机（实际上我还没准备好写些什么干货，先水一篇，立好 FLAG，避免自己懒癌犯了又忘了这回事）。

#### 重构定义

我很难无中生有，硬生生挤出一个让大家耳目一新的定义。关于重构，Martin  Fowler 曾在书中这样说道：

> Refactoring is the process of changing a software system in such a way that it does not alter the external behavior of the code yet improves its internal structure. It is a disciplined way to clean up code that minimizes the chances of introducing bugs. In essence when you refactor you are improving the design of the code after it has been written.
>
> 在不改变代码外在行为的前提下，对代码做出修改，以改进程序的内部结构。重构是一种经千锤百炼形成的有条不紊的程序整理方法，可以最大限度地减少整理过程中引入错误的几率。本质上说，重构就是在代码写好之后改进它的设计。

就我个人理解，重构的目的是为了让设计贯穿代码的整个生命过程：设计、编写、测试、优化、运行、维护、修改和删除。通过不同的重构技巧，针对代码某些阶段进行优化，实现正反馈机制，增加系统容错性，提高开发人员编程能力。

Dennis DeBruler 曾这样说过：

> Computer Science is the discipline that believes all problems can be solved with one more layer of indirection. 
>
> 计算机科学相信所有问题都可以通过增加一个间接层来解决。

重构中很重要的部分就是对间接层的管理，视情况进行增加或者减少。

####重构目的

重构不是万金油，能打理程序的方方面面，更不是一颗能让人顿悟编程之禅的银弹，但它可以是新冠疫情下的医用口罩，是 75% 的酒精。对于国家这个庞大的生态系统，它们阻止了事态恶化。对于个人，则成了人与人之间和谐相处的桥梁。重构就像单元测试，是为了延续代码生命周期的一个工具：

- 重构可以改过系统设计，避免设计崩塌，开发人员不重视，不断积累技术债。重构能不断改进项目设计，同时也会提高自身的代码设计能力：受够了产品不断提出的需求，每次修改轻辄复制粘贴，重辄伤筋动骨。通过重构不仅使代码更容易阅读，还能能改进自己的设计能力。 
- 重构可以帮助你理解项目，提高代码的可理解性。相信大家都不是项目最初的设计者和编写者
- 帮助找到程序错误，避免无端背黑锅：明明是调用的一个很久版本的函数，为什么会被测试测出问题。避免你陷入泥潭
- 重构能减少后期开发工作和维护成本：很多时候，重构的受益者其实是自己，你所编写的代码最终还是需要你自己的来维护。在匆匆忙忙间写下的代码，总有一天会出其不备产生一个隐藏的漏洞，然后夜半三更被 leader 叫起来改 bug。新增一个 feature 时，也会因为糟糕的设计，使得编码的道路险象迭生，稍不注意就会跌到一个隐藏的坑中，尽管这个坑是自己挖的，但它不会因为你是主人就放你一马，反而会变本加厉。只有不断改进最初的设计，才可以不断加快开发，保证开发质量。通过重构，封装条件逻辑，将变化进行隔离，对扩展开放，减少修改代码带来的副作用，
- ...

#### 重构时机

什么时候开始重构呢，一定要掌握相当多的技巧之后才能进行吗？曾经的我一度这么以为，但其实重构的起点非常简单，几乎没有任何门槛。我们只需要从整理代码开始，把变量或方法名中拼写错误的单词进行修正，将意图相似的方法移到一起进行管理，把类按照不同层次划分到不同包中，与团队保持一致的编码风格，定期格式化代码，遵循语言推荐的编程方式，根据 IDE 的提示减少项目中的 Warning等等。这些都是随手就可以做的事情，几乎花费不了多少时间，也不需要什么技巧。相反，如果我们选择视而不见，总是想着下次再改进，久而久之，代码就会慢慢腐烂，散发出阵阵恶臭，接手的人即使捂着鼻子也不愿去修改。

美国童子军有这样一条规则：“Leave the campground cleaner than you found it”（离开前让营地比你到来时更干净），对于重构的时机来说，亦如此，最好的时机就是当下。当然，我们没必要为了“重构”而重构，延误了正常的开发工作，“重构”理应是代码生命过程的一部分，而且是至关重要的一部分，就好比打扫卫生，整理房间是我们生活的一部分，但具体什么时候怎么做，需要靠我们自己去规划，去衡量。

在着手开始重构之前，我们先来捋一捋代码的哪些征兆告诉我们项目应该开始重构了：

- 重复代码：代码复制短期看节省了开发时间，但长期必然会加剧维护的难度。DRY（Don't repeat yourself）和 Rule of three（三次原则）告诉我们，相同的代码出现两次时无关紧要，但出现第三次时就应该开始重构了。项目中的重复代码就像是。阻碍了代码修改的脚步。不仅仅是表明上的代码重复，还包括逻辑重复，设计重复
- 过长函数：古代道家哲学就告诉我们“大道至简”，对于一个函数或是类来说，同样如此。我们不希望别人读自己写的函数到一半就已经不知道函数第一行的目的是什么了。虽然注释能帮助我们读懂代码，但请注意，注释不是除臭剂。再厉害的化妆品也阻挡不了时间的腐蚀，如果不加以优化，
- 过大的类：
- 过长参数：
- 难以扩展，牵一发而动全身：为了应对客户端传过来的各类参数情况，大量的 if else 头尾相连，构筑出一道铜墙铁壁。但等到添加新需求时，这道铜墙铁壁反而将我们拒之门外。
- 藕断丝连：
- 出现错误：
- 难以阅读：
- 表意不明：
- 文档断层：代码已经修改了好几个版本，但是文档依然没有得到更新，

优秀软件设计的最终目的都是奔着“高内聚低耦合”去的

并没有说函数多长才算长，不过可以以函数的职责多样性来判断。



### 写在最后

选择“重构”这个庞大的主题来作文章，到现在仍就是惴惴不安。毕竟要真正掌握它，需要大量的编码经验和项目设计经验。代码精进的道路路途遥远，对于我这个刚步入职场不到一年的菜鸟来说，恍若天堑。但千里之行始于足下，纵然步履维艰，也应上下求索。因而这将是一个持续更新的系列。我会不断结合书中所学，输出自身对“重构”的理解和实践。最后，非常赞成 Kent Beck 在《重构》一书结尾写的话：

> It's a little like walking along a narrow trail above a one-thousand-foot drop. As long as the light holds, you can step forward cautiously but with confidence. As soon as the sun sets, though, you'd better stop. You bed down for the night, sure the sun will rise again in the morning.
>
> 这有点像在悬崖峭壁上的小径行走，只要有光，你就可以前进，虽然谨慎却仍然自信。但是，一旦太阳下山，你就应该停止前进；夜晚你应该睡觉，并且相信明天早晨太阳仍旧升起。

重构剑法再现江湖，势必掀起一场血雨腥风，到底谁能笑到最后，取得那无上的武学造诣，还无人知晓。就让我们紧跟白衣少年的步伐，去探探隐藏在代码之界背后的秘密。下一篇文章将从函数的重构技巧说起，不见不散！

