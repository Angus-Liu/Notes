# 重构剑法之独钓寒江雪 

## 楔子

是夜，一轮明月挂在树梢，微风轻拂，掀起淡淡的泥土清香。

江边一艘小船靠岸停下，之前吹笛的白衣少年，此刻已起了倦意，合上了眼眸。

男子妄图趁白衣少年不备，

殊不知白衣少年早已用“委托”心法，把自己七魄中的二魄灵慧移到了鞘中利剑。

还未等男子靠近半分，咻的一声，剑锋直指男子

“卫语句”一出，原本让白衣少年步伐急促的情景得到改善。

男子的剑法再也无法靠近白衣少年。

男子邪魅一笑，上中下三路齐出，毒、暗器、内力和刀一并扔出

白衣少年，并不慌忙，一手“策略模式”将男子各路剑法一一化解。

事罢，白衣少年拂衣而去。

“这，是什么剑法？”，躺在地上的男子呼吸渐失，问了他在这世上的最后一个问题。

“重构”，一声回复从远处悠悠传来，江面上已不见之前的小船。

此刻，一轮红日从江面。

## 序章

随着对团队项目的理解不断加深，编码愈发熟练，因而开发之余会有一些时间去思考项目代码的优化。本系列文章便是记录自己从《重构（Refactoring）》一书中所学各项技巧在真实项目（以 Kotlin 为编程语言的 Web 后台项目）中的实践。如果其中有一条能让你运用在后续的代码编写中，对我来说就是莫大的鼓励和支持。

选择“重构”这个庞大的主题来写作文章，到现在心里仍就是惶恐不安。毕竟要真正掌握它，需要大量的编码经验和项目经验云云。代码精进的道路路途遥远，对于我这个刚步入职场不到一年的菜鸟来说，恍若天堑。但千里之行始于足下，纵然步履维艰，也应上下求索。

### 重构三问

这一篇文章让我们放松心情，先从概念出发，讲讲重构的定义、益处和时机（实际上我还没准备好写些什么干货，先水一篇，立好 FLAG，避免自己懒癌犯了又忘了这回事）。

#### 重构定义

关于重构的定义，Martin  在书中这样解释：

> Refactoring is the process of changing a software system in such a way that it does not alter the external behavior of the code yet improves its internal structure. It is a disciplined way to clean up code that minimizes the chances of introducing bugs. In essence when you refactor you are improving the design of the code after it has been written.
>
> 在不改变代码外在行为的前提下，对代码做出修改，以改进程序的内部结构。重构是一种经千锤百炼形成的有条不紊的程序整理方法，可以最大限度地减少整理过程中引入错误的几率。本质上说，重构就是在代码写好之后改进它的设计。

就我个人理解，重构的目的是为了让设计贯穿代码的整个生命过程：构思、编写、测试、运行、维护、修改和删除。通过重构的不同技巧，针对代码某些阶段进行优化，

####重构益处

既然“鼓吹 ”大家去重构，那必然是有很多好处的：

- 重构可以帮助你理解项目，提高代码的可理解性：相信大家都不是项目最初的设计者和编写者，
- 帮助找到程序错误，避免无端背黑锅：明明是调用的一个很久版本的函数，为什么会被测试测出问题。避免你陷入泥潭
- 重构能不断改进项目设计，同时也会提高自身的代码设计能力：受够了产品不断提出的需求，每次修改轻辄复制粘贴，重辄伤筋动骨。能改进自己的设计能力，使代码更容易阅读。
- 重构能减少后期开发工作和维护成本：很多时候，重构的受益者其实是自己，你所编写的代码最终还是需要你自己的来维护。在匆匆忙忙间写下的代码，总有一天会出其不备产生一个隐藏的漏洞，然后夜半三更被 leader 叫起来改 bug。新增一个 feature 时，也会因为糟糕的设计，使得编码的道路险象迭生，稍不注意就会跌到一个隐藏的坑中，尽管这个坑是自己挖的，但它不会因为你是主人就放你一马，反而会变本加厉。
- ...

#### 重构时机

美国童子军有这样一条规则：“Leave the campground cleaner than you found it”（离开前让营地比你到来时更干净），对于重构的时机来说，亦如此，最好的时机就是当下。

在着手开始重构之前，我们先来捋一捋代码的哪些征兆告诉我们项目应该开始重构了：

- 重复代码：代码复制短期看节省了开发时间，但长期必然会加剧维护的难度。DRY（Don't repeat yourself）和 Rule of three（三次原则）告诉我们，相同的代码出现两次时无关紧要，但出现第三次时就应该开始重构了。项目中的重复代码就像是。阻碍了代码修改的脚步
- 过长函数：古代道家哲学就告诉我们“大道至简”，对于一个函数或是类来说，同样如此。我们不希望别人读自己写的函数到一半就已经不知道函数第一行的目的是什么了。虽然注释能帮助我们读懂代码，但请注意，注释不是除臭剂。再厉害的化妆品也阻挡不了时间的腐蚀，如果不加以优化，
- 过大的类：
- 过长参数：
- 藕断丝连：

优秀软件设计的最终目的都是奔着“高内聚低耦合”去的

并没有说函数多长才算长，不过可以以函数的职责多样性来判断。

### 写在最后

关于重构，很赞成 Kent Beck 在书结尾写的话：

> It's a little like walking along a narrow trail above a one-thousand-foot drop. As long as the light holds, you can step forward cautiously but with confidence. As soon as the sun sets, though, you'd better stop. You bed down for the night, sure the sun will rise again in the morning.
>
> 这有点像在悬崖峭壁上的小径行走，只要有光，你就可以前进，虽然谨慎却仍然自信。但是，一旦太阳下山，你就应该停止前进；夜晚你应该睡觉，并且相信明天早晨太阳仍旧升起。

这是一个持续更新的系列，我将不断结合书中所学，输出自身对“重构”的理解和实践。

下一篇文章将从函数的重构技巧说起，不见不散！